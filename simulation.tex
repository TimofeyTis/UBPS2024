\section{Модуль симуляции}
\label{par:MARLIN24_sim}
Модуль симуляции предназначен для оценки эффективности выбранного управления светофорными объектами.
В модуле реализованы две микросимуляционные модели движения,  описывающая перемещения транспортных средств по дорожной сети. 
Первая модель IDM (Intelligent Driver Model) реализует движение транспортных средств по однополосной прямой дороге \cite{IDM}. 
Вторая модель --- MOBIL  (Microscopic Optimally Balanced Intersection Lanes), описывает перестроение на многополосной дороге \cite{MOBIL}.
В процессе симуляции движения транспортных средств 
 учитывается управление фазами и циклами  светофорных  объектов, а также предусмотрено имитирование  показаний оптических датчиков и работы светофоров.

\subsection{Модели движения транспортных средств}
\label{subpar: IDM_math}
Для описания движения отдельных транспортных средств используется модель IDM \cite{IDM}.
%В модели движения транспортных средств необходимо 
Данная модель позволяет учитывать следующие параметры: минимальная безопасная дистанция, максимальная разрешенная скорость и коэффициент торможения транспортных средств.
%Данные параметры  могут оказывать существенное влияние при описании загруженных участков дорожной сети. 
% В связи с этим предлагается использовать математическую модель  интеллектуального водителя IDM, которая позволяет описывать движение с учетом указанных параметров.
В таблице \ref{table:transp_definitions} представлены значения параметров для модели IDM, используемые далее в статье.
\begin{table}[tbph]
    \caption{Основные обозначения для модели IDM }\label{table:transp_definitions}
    \centering
    \scalebox{0.78}{
    \begin{tabular}{|c|p{0.7\textwidth}|}
        \hline
        Символ                        & Значение                                 \\
        \hline
        \rule{0em}{1.3em}${i} $       & номер транспортного средства              \\\hline
        %\rule{0em}{1.3em}$j$ & следующий за $i$ автомобиль на целевой для перестроения полосе движения  \\\hline
        \rule{0em}{1.3em}${s}_{0,i} $ & минимальная безопасная дистанция для т.с. $i$ \\\hline
        \rule{0em}{1.3em}$v_{0,i}$    & максимальная желательная скорость $i$    \\\hline
        \rule{0em}{1.3em}$\delta $    & компонента <<гладкости>> ускорения       \\\hline
        \rule{0em}{1.3em}$T_i$        & время реакции $i$-го водителя            \\\hline
        \rule{0em}{1.3em}${a}_i $     & ускорение $i$               \\\hline
        \rule{0em}{1.3em}$ b_i$       & коэффициент торможения $i$                \\\hline
        \rule{0em}{1.3em}$s^\ast$     & желаемое расстояние между $i$ и $i-1$   \\\hline
        % \rule{0em}{1.3em}$\widetilde{a}_{i}$ &  ускорение транспортного средства $i$ после изменения дорожной обстановки\\\hline 
    \end{tabular}}
\end{table}

Модель IDM относится к классу моделей движения за лидером.
Все транспортные  средства рассматриваются как индивидуальные сущности,  обладающие  характеристиками и поведением.
Водители транспортных  средств регулируют скорость в зависимости от расстояния до впереди идущих и их скоро\-сти.
На рисунке \ref{fig:IDM_illustration} представлено взаимное расположение и характеристики текущего автомобиля, расположенного в $i$-ой  позиции, и $(i-1)$-го автомобиля, находящегося перед ним.
\begin{figure}[tbph]
    \centering
    \includegraphics[width = 0.7\textwidth]{sim_descr.pdf}
    \caption{Иллюстрация модели IDM}\label{fig:IDM_illustration}
\end{figure}



Система уравнений, описывающих текущую скорость  $i$-го автомобиля  и расстояние до $(i-1)$-го автомобиля в модели IDM в классических обозначениях имеет вид:
\begin{equation} \label{eq:IDM_sys}
    \left\{
    \begin{array}{l}
        \displaystyle   \frac{dv_i}{dt}=
        \underbrace{a_i\Biggl( 1-\left(\frac{v_i}{v_{0,i}}\right)^\delta\Biggr)}_{\displaystyle a_{\mathrm{free\;road}}}-
        \underbrace{a_i\Biggl( \frac{s^*\left(v_i\Delta v_i\right)}{s_i}\Biggr)^2}_{\displaystyle a_{\mathrm{deceleration}}}, \\
        \displaystyle
        s^*\left(v_i, \Delta v_i\right)=s_{0,i}+v_iT_i+\frac{v_i\Delta v_i}{2\sqrt{a_ib_i}},
    \end{array}\right.
\end{equation}
где  $a_{\mathrm{free\;road}}$ обозначает ускорение, возникающее на свободной дороге, $a_{\mathrm{deceleration}}$ --- замедление, возникающее при сближении транспортных средств.




При имитационном моделировании для нахождения значений скоро\-сти и ускорения  использовались формулы, вытекающие из численного метода <<пристрелки>> \cite{SHOOT}:
\[
    \left\{
    \begin{array}{l}
        \displaystyle\frac{dv}{dt}(t) =  a_{\mathrm{free\;road}}(t)+a_{\mathrm{deceleration}}(t),        \\
        \displaystyle v(t+\Delta t)    =  v(t) + \frac{dv}{dt}(t)\Delta t,                               \\
        \displaystyle x(t+\Delta t)    =  x(t)+v(t)\Delta t+ \frac{1}{2}  \frac{dv}{dt}(t) (\Delta t)^2, \\
        \displaystyle s(t+\Delta t)    =  x_i(t+\Delta t)- x(t+\Delta t)- {l}_i.
    \end{array}
    \right.
\]
Шаг  симуляции $dt$ выбирается как шаг по времени при численном решении системы (\ref{eq:IDM_sys}).

Существенным ограничением модели IDM является ее применимость только к однополосному движению.
Одним из способов расширить ее применимость к многополосным дорожным сетям является введение алгоритмов, описывающих перестроение транспортных средств.
В работе используется модель MOBIL \cite{MOBIL}.

В основе модели MOBIL лежит идея о том, что водители принимают решения о перестроении и изменении скорости движения из соображений проходимости и безопасности.
Конкретное изменение полосы движения, например с правой полосы движения на левую полосу, как показано на {рисунке~\ref{fig:MOBIL},} зависит, как правило, от двух следующих транспортных средств на текущей полосе движения и соответственно на целевой полосе движения.

\begin{figure}[tbph]
    \centering
    \includegraphics[width = 0.75\textwidth]{mobil.pdf}
    \caption{Модель смены полосы MOBIL}\label{fig:MOBIL}
\end{figure}

Стимул для перестроения есть, если после первого фиктивного  перестроения  с правой полосы $R$ на левую полосу $L$ сумма собственного  ускорения  согласно модели IDM и ускорения соседних транспортных средств выше на порог изменения $\delta$:
$$
    R\to L: \quad \left(\widetilde{a_i}-a_i \right) + m\left((\widetilde{a}_{i+1}-a_{i+1})  + (\widetilde{a_j}-a_j)  \right) \geqslant \delta,
$$
\noindent
где  $m \in \left[ -\infty;\frac{1}{2}\right]\cup  \left[1; +\infty\right]$ ---  вручную задаваемый коэффициент вежливости, символ <<$\widetilde{\;}$>> обозначает измененные характеристики.
В \cite{MOBIL} предложены следующие интерпретации коэффициента  $m$:
{
\begin{description}[itemsep=-3pt, topsep=0pt]
    \item[ {$\mathit{m > 1, }$                                } \it{альтруистичное поведение}:] автомобиль не перестраивается, если он ухудшит  общую дорожную ситуацию;
    \item[ {$\mathit{0 \leqslant m \leqslant 0.5, }$  } \it{реалистичное поведение}:  ] движение остальных  транс\-порт\-ных средств менее приоритетно;
    \item[ {$\mathit{m<0, }$                                  } \it{вредительское поведение}: ] автомобиль перестраивается, если он замедлит остальные. %\red{может описывать поведение ДПС или водителей из Средней Азии}. 
\end{description}
}
Также следует учитывать, что при перестроении $i$ на соседнюю полосу транспортные средства $j$ и следующие за ним должны двигаться с коэффициентом торможения больше, чем $b.$ Поскольку в модели IDM скорости, а, следовательно, и ускорения связаны формулой   (\ref{eq:IDM_sys}) и изменяются последовательно от лидирующего транспортного средства к последующему, то описать такое замедление можно формулой:
$
    \widetilde{a_j} \geqslant -b.
$
\subsection{Описание работы модуля}
\label{subpar:IDM module}
Модуль симуляции трафика на  вход получает конфигурационный файл  {VehicleConfig.xml}, в котором содержатся такие параметры как максимально разрешенная скорость, коэффициент торможения (покрытие дороги),  количество полос.
Дополнительно, в модуль симуляции  поступает  информация о дорожной сети в виде мультиграфа {map.osm},  предобработанная библиотекой osmnx \cite{osmnx}.
Для построения  маршрутов  транспортных средств  в дорожной сети  используется библиотека  networkx \cite{networkx}.

Каждый шаг по времени $t$ в модуле симуляции может быть отображен в модуле визуализации с использованием библиотеки pygame.
Модуль визуализации отрисовывает дорожную сеть, транспортные средства и отладочную информацию, а также позволяет изменять модельное время.
% Использование графических средств и модуля симуляции значительно ускоряет процесс отладки и исследования моделей управления светофорами.


% Поскольку построение маршрутов транспорта является весьма трудоемкой задачей,  то для ускорения инициализации модели используется   многопоточная реализация алгоритма построения маршрутов при помощи модуля  threading\cite{python-threading}.
% При построении дорожной, сети вершинам присваивается уникальный номер osmid. Каждая вершина представляет узел (перекресток, регулируемый пешеходный переход) или место существенного изменения характеристик дороги.  Каждое ребро соответствует реальному участку дороги без перекрестков.
% В ребрах хранится информация о соединяемых ими вершинах, их координатах, длине дороги, количестве полос, названии улицы, а также других параметрах из табл. \ref{table:road_params_OSM}.

% \begin{table}[h!]
%     \caption{Импортируемые параметры дорог из OSM}\label{table:road_params_OSM}
%     \scalebox{0.72}{
%         \begin{tabular}{|l||l|l|}\hline
%             \rule{0em}{1.5em}\textbf{Параметр} & \textbf{Принимаемые значения}                                                                       & \textbf{Описание} \hfill                                                                                                                             \\\hline
%             lanes                              & int                                                                                                 & число полос.                                                                                                                                         \\\hline
%             highway                            & \begin{tabular}[c]{@{}l@{}}residential\\ primary\\ secondary\\ terliary\\ unclassified\end{tabular} & \begin{tabular}[c]{@{}l@{}} внутри жилых зон,\\ федерального,\\ областного,\\ местного значения,\\ образующие соединительную сеть дорог\end{tabular} \\\hline
%             lanes                              & str                                                                                                 & название улицы                                                                                                                                       \\\hline
%             oneway                             & bool                                                                                                & дороги, которые проходят внутри жилых зон                                                                                                            \\\hline
%             reversed                           & bool                                                                                                & \begin{tabular}[c]{@{}l@{}}направление движения дорог \end{tabular}                                                                                  \\\hline
%             length                             & float                                                                                               & длинна дороги                                                                                                                                        \\\hline
%         \end{tabular}}
% \end{table}
