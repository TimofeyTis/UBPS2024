\section{Модуль симуляции}
\label{par:MARLIN24_sim}

\subsection{модели движения трансопртных средств}
вся математика

\subsection{описание работы модуля}
вся математика
Модуль симуляции предназначен для оценки эффективности выбранного управления. 
Модуль симуляции трафика на  вход получает конфигурационный файл  {VehicleConfig.xml}, в котором содержатся такие параметры как максимально разрешенная скорость, коэффициент торможения (покрытие дороги),  количество полос.
Дополнительно, в модуль симуляции  поступает  информация о дорожной сети в виде мультиграфа {map.osm},  предобработанная библиотекой osmnx\cite{OSM}.
Для построения  маршрутов  транспортных средств  в дорожной сети  используется библиотека  networkx\cite{networkx}.  
Данный модуль позволяет имитировать показания оптических датчиков. 
Каждый шаг по времени $t$ в модуле симуляции может быть отображен в модуле визуализации с использованием библиотеки pygame.
Модуль визуализации отрисовывает дорожную сеть, транспортные средства и отладочную информацию, а также позволяет изменять модельное время. 
Использование графических средств и модуля симуляции значительно ускоряет процесс отладки и исследования моделей управления светофорными объектами.

Скриншот графического интерфейса MARLIN24 изображен на рисунке~\ref{fig:ex3}а, 
 зоны работы оптических датчиков --- на  рисунке~\ref{fig:ex3}б.


\begin{figure}[tbph]
    \centering
    \scalebox{1}{
    а)\includegraphics[width = 0.48\textwidth]{model_ex.pdf}
    б)\includegraphics[width = 0.44\textwidth]{SV-VIS_78.jpg}
    }
    \caption{а)скриншот окна комплекса  MARLIN24; \linebreak б)зоны оптических датчиков (жёлтый цвет) }
    \label{fig:ex3}
\end{figure}


% Поскольку построение маршрутов транспорта является весьма трудоемкой задачей,  то для ускорения инициализации модели используется   многопоточная реализация алгоритма построения маршрутов при помощи модуля  threading\cite{python-threading}.
% При построении дорожной, сети вершинам присваивается уникальный номер osmid. Каждая вершина представляет узел (перекресток, регулируемый пешеходный переход) или место существенного изменения характеристик дороги.  Каждое ребро соответствует реальному участку дороги без перекрестков.
% В ребрах хранится информация о соединяемых ими вершинах, их координатах, длине дороги, количестве полос, названии улицы, а также других параметрах из табл. \ref{table:road_params_OSM}.

% \begin{table}[h!]
%     \caption{Импортируемые параметры дорог из OSM}\label{table:road_params_OSM}
%     \scalebox{0.72}{
%         \begin{tabular}{|l||l|l|}\hline
%             \rule{0em}{1.5em}\textbf{Параметр} & \textbf{Принимаемые значения}                                                                       & \textbf{Описание} \hfill                                                                                                                             \\\hline
%             lanes                              & int                                                                                                 & число полос.                                                                                                                                         \\\hline
%             highway                            & \begin{tabular}[c]{@{}l@{}}residential\\ primary\\ secondary\\ terliary\\ unclassified\end{tabular} & \begin{tabular}[c]{@{}l@{}} внутри жилых зон,\\ федерального,\\ областного,\\ местного значения,\\ образующие соединительную сеть дорог\end{tabular} \\\hline
%             lanes                              & str                                                                                                 & название улицы                                                                                                                                       \\\hline
%             oneway                             & bool                                                                                                & дороги, которые проходят внутри жилых зон                                                                                                            \\\hline
%             reversed                           & bool                                                                                                & \begin{tabular}[c]{@{}l@{}}направление движения дорог \end{tabular}                                                                                  \\\hline
%             length                             & float                                                                                               & длинна дороги                                                                                                                                        \\\hline
%         \end{tabular}}
% \end{table}
Симуляционный модуль должен учитывать 
фазы, циклы и программы управления  светофорных  объектов.
Конфигурационный файл {TrafficLightConfig.xml} содержит информацию об активируемых фазах и активируемых направлениях для выбранных светофорных объектов.

В симуляционном модуле движение транспортных средств должно учитывать минимальную безопасную дистанцию, максимальную разрешенную скорость и коэффициент торможения транспортных средств. Данные параметры  могут оказывать существенное влияние при описании загруженных участков дорожной сети. 

Модель  интеллектуального водителя (IDM, Intelligent Driver Model)\cite{IDM} позволяет описывать движение с учетом выбранных параметров.
В модели IDM все транспортные  средства рассматриваются как индивидуальные сущности,  обладающие  характеристиками и поведением.
Модель IDM относится к классу моделей движения за лидером,  она основана на взаимодействии между автомобилями, где каждый водитель регулирует скорость своего автомобиля в зависимости от расстояния до впереди идущего транспорта, его скоро\-сти и собственной скоро\-сти.
На рисунке \ref{fig:IDM_illustration} представлено взаимное расположение и характеристики текущего автомобиля, расположенного в $i$-ой  позиции, и $(i-1)$-го автомобиля, находящегося перед ним.
\begin{figure}[tbph]
    \centering
    \includegraphics[width = 0.65\textwidth]{sim_descr.pdf}
    \caption{Иллюстрация модели IDM}\label{fig:IDM_illustration}
\end{figure}

Система уравнений, описывающих текущую скорость  $i$-го автомобиля  и расстояние до $(i-1)$-го автомобиля в модели IDM в классических обозначениях имеет вид:
\begin{equation} \label{eq:IDM_sys}
    \left\{
    \begin{array}{l}
        \displaystyle   \frac{dv_i}{dt}=
        \underbrace{a_i\Biggl( 1-\left(\frac{v_i}{v_{0,i}}\right)^\delta\Biggr)}_{\displaystyle a_{\mathrm{free}}}-
        \underbrace{a_i\Biggl( \frac{s^*\left(v_i\Delta v_i\right)}{s_i}\Biggr)^2}_{\displaystyle a_{\mathrm{deceleration}}}, \\
        \displaystyle
        s^*\left(v_i, \Delta v_i\right)=s_{0,i}+v_iT_i+\frac{v_i\Delta v_i}{2\sqrt{a_ib_i}}.
    \end{array}\right.
\end{equation}

При имитационном моделировании для нахождения значений скоро\-сти и ускорения  будем пользоваться формулами, вытекающими из численного метода <<пристрелки>> {\cite{SHOOT}}:
\[
    \left\{
    \begin{array}{l}
        \displaystyle\frac{dv}{dt}(t) =  a_{\mathrm{free}}(t)+a_{\mathrm{deceleration}}(t),              \\
        \displaystyle v(t+\Delta t)    =  v(t) + \frac{dv}{dt}(t)\Delta t,                               \\
        \displaystyle x(t+\Delta t)    =  x(t)+v(t)\Delta t+ \frac{1}{2}  \frac{dv}{dt}(t) (\Delta t)^2, \\
        \displaystyle s(t+\Delta t)    =  x_i(t+\Delta t)- x(t+\Delta t)- {l}_i.
    \end{array}
    \right.
\]
Шаг  симуляции $dt$ выбирается как шаг по времени при численном решении системы (\ref{eq:IDM_sys}).

{
Существенным ограничением модели IDM является ее применимость только к однополосному движению.
Одним из способов расширить ее применимость к многополосным дорожным сетям является введение алгоритмов, описывающих перестроение транспортных средств.
В работе используется модель MOBIL (Microscopic Optimally Balanced Intersection Lanes). 

В основе модели MOBIL лежит идея о том, что водители принимают решения о перестроении и изменении скорости движения из соображений проходимости и безопасности.
Конкретное изменение полосы движения, например с правой полосы движения на левую полосу, как показано на {рисунок~\ref{fig:MOBIL},} зависит, как правило, от двух следующих транспортных средств на текущей полосе движения и соответственно на целевой полосе движения.

\begin{figure}[tbph]
    \centering
    \includegraphics[width = 0.5\textwidth]{mobil.pdf}
    \caption{Модель смены полосы MOBIL}\label{fig:MOBIL}
\end{figure}



Стимул для перестроения есть, если после первого фиктивного  перестроения  с правой полосы $R$ на левую полосу $L$ сумма собственного  ускорения  согласно модели IDM и ускорения соседних транспортных средств выше на порог изменения $\delta$:
{
\abovedisplayskip=-0.0em
\belowdisplayskip=0em
$$
    R\to L: \quad \left(\widetilde{a_i}-a_i \right) + p\left((\widetilde{a}_{i+1}-a_{i+1})  + (\widetilde{a_j}-a_j)  \right) \geqslant \delta,
$$ }
\noindent
где  $p \in \left[ -\infty;\frac{1}{2}\right]\cup  \left[1; +\infty\right]$ ---  вручную задаваемый коэффициент вежливости, символ $\;\widetilde{}$ обозначает измененные характеристики.

Также следует учитывать, что при перестроении $i$ на соседнюю полосу транспортные средства $j$ и следующие за ним должны двигаться с коэффициентом торможения больше, чем $b_{\mathrm{safe}}.$ Поскольку в модели IDM скорости, а, следовательно, и ускорения связаны формулой   (\ref{eq:IDM_sys}) и изменяются последовательно от лидирующего транспортного средства к последующему, то описать такое замедление можно формулой:
$
    \widetilde{a_j} \geqslant -b_{\mathrm{safe}}.
$